<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>게시글 조회</title>
    <style>
      /* 전체 페이지 기본 스타일 */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        display: flex;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        min-height: 100vh;
      }

      /* 메인 컨테이너 */
      .post-container {
        background-color: #fff;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 900px; /* 게시글 상세 보기 컨테이너 너비 */
        box-sizing: border-box;
      }

      /* 게시글 제목 */
      .post-title-area {
        border-bottom: 2px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 20px;
      }

      .post-title {
        font-size: 2.2rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
        word-break: break-word; /* 제목이 길 경우 줄바꿈 */
      }

      /* 게시글 정보 (작성자, 날짜, 조회수 등) */
      .post-info {
        display: flex;
        flex-wrap: wrap; /* 반응형을 위해 줄바꿈 허용 */
        justify-content: space-between;
        font-size: 0.95rem;
        color: #777;
        gap: 10px; /* 요소들 간의 간격 */
      }

      .post-info span {
        margin-right: 15px;
      }

      .post-info .author {
        font-weight: 500;
        color: #555;
      }

      .post-info .separator::after {
        content: "|";
        margin-left: 15px;
        color: #ccc;
      }

      /* 게시글 내용 */
      .post-content {
        line-height: 1.8;
        font-size: 1.1rem;
        color: #444;
        min-height: 150px; /* 최소 높이 */
        padding: 20px 0;
        /* border-bottom: 1px solid #eee; */ /* 이 부분은 제거된 상태 유지 */
        white-space: pre-wrap; /* 공백과 줄바꿈 유지 */
        word-break: break-word; /* 긴 단어도 잘라 다음 줄로 넘어가도록 */
      }

      /* 첨부파일 섹션 */
      .post-files {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid #eee; /* 이 부분은 다시 추가하여 좋아요 섹션과 첨부파일 섹션 사이에 구분선 역할 */
      }

      .post-files h3 {
        font-size: 1.2rem;
        color: #555;
        margin-bottom: 10px;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      /* 각 파일 항목 (회색 네모칸) */
      .file-list li {
        margin-bottom: 10px; /* 각 파일 항목 아래에 간격 추가 */
        padding: 10px 15px; /* 내부 여백 */
        background-color: #f9f9f9; /* 연한 회색 배경 */
        border: 1px solid #e0e0e0; /* 연한 테두리 */
        border-radius: 8px; /* 둥근 모서리 */
        display: flex;
        align-items: center;
        width: 100%; /* 부모 너비 전체 사용 */
        box-sizing: border-box; /* 패딩과 테두리를 너비에 포함 */
      }

      .file-list li:last-child {
        margin-bottom: 0; /* 마지막 항목 아래 간격 제거 */
      }

      .file-list li:hover {
        background-color: #f0f0f0; /* 호버 시 배경색 변경 */
        border-color: #c0c0c0; /* 호버 시 테두리색 변경 */
      }

      .file-list a {
        color: #2563eb;
        text-decoration: none;
        font-weight: 500;
        white-space: nowrap; /* 파일 이름이 한 줄에 표시되도록 */
        overflow: hidden; /* 넘치는 부분 숨김 */
        text-overflow: ellipsis; /* 넘치는 부분 ...으로 표시 */
        margin-right: 5px; /* 파일 크기 정보와의 간격 */
      }

      .file-list a:hover {
        text-decoration: underline;
      }

      /* 파일 아이콘 스타일 */
      .file-list .file-icon {
        width: 20px; /* 아이콘 너비 */
        height: 20px; /* 아이콘 높이 */
        vertical-align: middle; /* 텍스트와 세로 정렬 */
        margin-right: 8px; /* 텍스트와의 간격 */
        flex-shrink: 0; /* 아이콘이 줄어들지 않도록 */
      }

      /* 파일 크기 정보 */
      .file-list .file-size-info {
        font-size: 0.9em;
        color: #777;
        margin-left: auto; /* 파일 이름과 파일 크기 정보를 양 끝으로 보내기 위해 */
        flex-shrink: 0; /* 크기 정보가 줄어들지 않도록 */
      }

      /* 첨부파일 없음 메시지 */
      .no-files-message {
        font-size: 1rem;
        color: #888;
        padding: 15px;
        border: 1px dashed #e0e0e0;
        border-radius: 8px;
        background-color: #fcfcfc;
        text-align: center;
      }

      /* 좋아요 버튼 섹션 */
      .like-section {
        display: flex;
        justify-content: center; /* 중앙 정렬 */
        align-items: center;
        margin: 30px 0; /* 상하 여백 */
        padding: 20px 0;
        border-top: 1px solid #eee; /* 이 부분을 유지하여 content와 좋아요 섹션 사이에 구분선 */
        /* border-bottom: 1px solid #eee; */ /* 이 부분을 제거 또는 주석 처리 */
      }

      .like-button {
        background-color: #e0f2fe; /* 연한 파란색 배경 */
        color: #3b82f6; /* 파란색 텍스트 */
        border: 1px solid #93c5fd;
        border-radius: 9999px; /* 동그란 버튼 */
        padding: 12px 25px;
        font-size: 1.1rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px; /* 아이콘과 텍스트 사이 간격 */
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.2s ease,
          box-shadow 0.2s ease;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .like-button:hover {
        background-color: #dbeafe; /* 호버 시 더 연한 파란색 */
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .like-button img {
        width: 24px;
        height: 24px;
      }

      .like-count {
        font-size: 1.2rem;
        font-weight: bold;
        margin-left: 5px; /* 버튼과의 간격 */
        color: #333;
      }

      /* 버튼 그룹 */
      .post-actions {
        display: flex;
        justify-content: flex-end; /* 오른쪽 정렬 */
        gap: 10px;
        margin-top: 30px;
      }

      .action-button {
        padding: 10px 20px;
        background-color: #4f46e5;
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        text-decoration: none; /* a 태그 스타일 제거 */
        display: inline-block; /* 패딩 적용을 위해 */
        font-size: 1rem; /* 모든 버튼의 글씨 크기를 1rem으로 통일 */
      }

      .action-button:hover {
        background-color: #4338ca;
      }

      /* 삭제, 수정 버튼 색상 */
      .delete-button {
        background-color: #dc2626; /* 빨간색 계열 */
      }

      .delete-button:hover {
        background-color: #b91c1c;
      }

      .edit-button {
        background-color: #f59e0b; /* 주황색 계열 */
      }

      .edit-button:hover {
        background-color: #d97706;
      }

      .list-button {
        background-color: #6b7280; /* 회색 계열 */
      }

      .list-button:hover {
        background-color: #4b5563;
      }

      /* 게시글이 삭제된 경우 */
      .deleted-message {
        text-align: center;
        font-size: 1.5rem;
        color: #888;
        padding: 50px 0;
        margin-bottom: 20px;
        border: 1px dashed #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
        text-align: center;
      }
    </style>
    <link rel="stylesheet" href="/css/navbar.css" />
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <navbar-component></navbar-component>

    <div id="app" class="post-container">
      <template v-if="post">
        <div class="post-title-area">
          <h1 class="post-title">{{ post.title }}</h1>
          <div class="post-info">
            <div>
              <span class="author">{{ post.author }}</span>
              <span class="separator"></span>
              <span>작성일: {{ post.formattedCreatedAt }}</span>
              <template v-if="post.isUpdated">
                <span class="separator"></span>
                <span>(수정일: {{ post.formattedUpdatedAt }})</span>
              </template>
            </div>
            <div>
              <span>조회수: {{ post.viewCount }}</span>
              <span class="separator"></span>
              <span>추천수: {{ post.likeCount }}</span>
            </div>
          </div>
        </div>

        <div class="post-content">{{ post.content }}</div>

        <div class="like-section">
          <button type="button" class="like-button" @click="toggleLike">
            <img :src="getLikeIconSrc()" alt="좋아요" />
            <span>좋아요</span>
            <span class="like-count">{{ post.likeCount }}</span>
          </button>
        </div>

        <div class="post-files">
          <h3>첨부파일</h3>
          <template v-if="post.files && post.files.length > 0">
            <ul class="file-list">
              <li v-for="file in post.files" :key="file.fileId">
                <img
                  :src="getFileIconSrc(file.fileType)"
                  :alt="file.originalFileName"
                  class="file-icon"
                />
                <a
                  :href="getFileDownloadUrl(file.fileId)"
                  :download="file.originalFileName"
                  >{{ file.originalFileName }}</a
                >
                <span class="file-size-info"
                  >({{ formatFileSize(file.fileSize) }})</span
                >
              </li>
            </ul>
          </template>
          <template v-else>
            <p class="no-files-message">첨부파일이 없습니다.</p>
          </template>
        </div>

        <div class="post-actions">
          <button
            type="button"
            class="action-button edit-button"
            @click="editPost(post.postId)"
          >
            수정
          </button>
          <button
            type="button"
            class="action-button delete-button"
            @click="deletePost"
          >
            삭제
          </button>
          <a href="/posts" class="action-button list-button">목록으로</a>
        </div>
      </template>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script type="module">
      import Navbar from "./components/Navbar.js";

      const { createApp, ref, onMounted } = Vue;

      createApp({
        setup() {
          // ***** [ 변수 세팅 ] *****
          const post = ref(null);
          const postId = window.location.pathname.split("/").pop(); // URI에서 postId 추출
          const hasLike = ref(false);

          // ***** [ 게시글 불러오기 ] *****
          const fetchPost = async () => {
            try {
              const response = await fetch(`/api/posts/${postId}`);
              const data = await response.json();

              // 성공
              if (response.ok) {
                post.value = data;
              } else if (response.status === 403 || response.status === 404) {
                // 사용자가 존재하지 않는 게시글이나 삭제된 게시글에 접근하는 경우
                const params = new URLSearchParams({
                  code: data.statusCode || response.status,
                  title: data.errorPageTitle || "오류 발생",
                  message: data.message || "알 수 없는 오류가 발생했습니다.",
                });

                window.location.href = `/error-page?${params.toString()}`; // 에러 페이지로 리다이렉트
              } else {
                console.error("게시글 조회 중 오류가 발생했습니다");
                post.value = null;
              }
            } catch (error) {
              console.error("게시글 조회 중 네트워크 에러 발생:", error);
              post.value = null;
            }
          };

          // ***** [ 해당 게시글에 좋아요를 눌렀는지 확인 ] *****
          const checkLike = async () => {
            try {
              // API 호출 (/api/posts/{postId}/like/check)
              const response = await fetch(`/api/posts/${postId}/like/check`);
              const isLiked = await response.json();

              if (response.ok) {
                hasLike.value = isLiked;
              } else {
                console.error("좋아요 상태 확인 중 오류 발생");
                hasLike.value = false;
              }
            } catch (error) {
              console.error("좋아요 상태 확인 중 네트워크 에러 발생:", error);
              hasLike.value = false;
            }
          };

          // ***** [ 마운트 시 게시글 조회 및 좋아요 상태 확인 ] *****
          onMounted(() => {
            fetchPost();
            checkLike();
          });

          // ***** [ 첨부파일 다운로드 URL 생성 ] *****
          const getFileDownloadUrl = (fileId) => {
            return `/api/files/${fileId}`;
          };

          // ***** [ 파일 사이즈 포매팅 ] *****
          const formatFileSize = (bytes) => {
            if (bytes === 0) return "0 Bytes";

            const k = 1024;
            const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
            const i = Math.floor(Math.log(bytes) / Math.log(k));

            return (
              parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
            );
          };

          // ***** [ 파일 종류에 따른 아이콘 경로 반환 ] *****
          const getFileIconSrc = (fileType) => {
            if (fileType.startsWith("image/")) {
              return "/icons/image.svg";
            } else if (fileType === "application/pdf") {
              return "/icons/pdf.svg";
            } else if (
              fileType.includes("wordprocess") ||
              fileType.includes("officedocument.wordprocessingml")
            ) {
              return "/icons/word.svg";
            } else if (
              fileType.includes("excel") ||
              fileType.includes("spreadsheet") ||
              fileType.includes("officedocument.spreadsheetml")
            ) {
              return "/icons/excel.svg";
            } else if (
              fileType.includes("powerpoint") ||
              fileType.includes("presentation") ||
              fileType.includes("officedocument.presentationml")
            ) {
              return "/icons/ppt.svg";
            } else if (
              fileType === "application/zip" ||
              fileType === "application/x-zip-compressed" ||
              fileType === "application/vnd.rar"
            ) {
              return "/icons/zip.svg";
            } else {
              return "/icons/file.svg";
            }
          };

          // ***** [ 좋아요 여부에 따른 아이콘 경로 반환 ] *****
          const getLikeIconSrc = () => {
            if (hasLike.value) {
              return "/icons/heart.svg";
            } else {
              return "/icons/empty-heart.svg";
            }
          };

          // ***** [ 좋아요 버튼을 클릭한 경우 ] *****
          const toggleLike = async () => {
            const method = hasLike.value ? "DELETE" : "POST";

            try {
              const response = await fetch(`/api/posts/${postId}/like`, {
                method: method,
              });

              if (response.ok) {
                hasLike.value = !hasLike.value;
                await fetchPost();
              } else {
                const errorData = await response.json();

                alert("좋아요 처리 중 오류가 발생했습니다.");
                console.error("좋아요 처리 중 오류 발생:", errorData);
              }
            } catch (error) {
              alert("네트워크 오류로 좋아요 처리에 실패했습니다.");
              console.error("좋아요 처리 중 네트워크 에러 발생:", error);
            }
          };

          // ***** [ 수정 버튼을 클릭한 경우 ] *****
          const editPost = (postId) => {
            window.location.href = `/posts/${postId}/edit`;
          };

          // ***** [ 삭제 버튼을 클릭한 경우 ] *****
          const deletePost = async () => {
            if (confirm("정말로 이 게시글을 삭제하시겠습니까?")) {
              try {
                const response = await fetch(`/api/posts/${postId}`, {
                  method: "DELETE",
                });

                if (response.ok) {
                  alert("게시글이 삭제되었습니다.");
                  window.location.href = "/posts";
                } else {
                  const errorData = await response.json();
                  alert(
                    `게시글 삭제 중 오류가 발생했습니다: ${
                      errorData.message || response.statusText
                    }`
                  );
                  console.error("게시글 삭제 중 오류 발생:", errorData);
                }
              } catch (error) {
                console.error("게시글 삭제 중 네트워크 에러 발생:", error);
                alert("게시글 삭제 중 에러가 발생했습니다.");
              }
            }
          };

          return {
            post,
            getFileDownloadUrl,
            formatFileSize,
            getFileIconSrc,
            getLikeIconSrc,
            toggleLike,
            editPost,
            deletePost,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
