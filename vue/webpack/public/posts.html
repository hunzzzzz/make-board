<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>게시글 목록</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
      /* JSP 파일에서 제공해주신 CSS를 여기에 그대로 붙여넣습니다. */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
        display: flex;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
        min-height: 100vh;
      }

      .container {
        background-color: #fff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 1200px; /* 게시글 목록 컨테이너 너비를 1200px로 유지 */
      }

      h1 {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap; /* 반응형을 위해 줄바꿈 허용 */
        gap: 15px; /* 요소들 간의 간격 */
      }

      .search-form {
        display: flex;
        gap: 8px;
        flex-grow: 1; /* 검색 폼이 공간을 차지하도록 */
      }

      .search-form input[type="text"] {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      .search-form button,
      .action-button {
        padding: 10px 15px;
        background-color: #4f46e5;
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }

      .search-form button:hover,
      .action-button:hover {
        background-color: #4338ca;
      }

      .sort-select {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        font-size: 1rem;
        background-color: #fff;
        cursor: pointer;
        box-sizing: border-box;
      }

      .post-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .post-table th,
      .post-table td {
        border: 1px solid #e0e0e0;
        padding: 12px 15px;
        text-align: left; /* 기본 왼쪽 정렬 */
      }

      /* 가운데 정렬이 필요한 컬럼 */
      .post-table th:nth-child(1), /* 번호 */
        .post-table th:nth-child(3), /* 작성자 */
        .post-table th:nth-child(6) {
        /* 작성일 */
        text-align: center;
      }
      .post-table td:nth-child(1), /* 번호 */
        .post-table td:nth-child(3), /* 작성자 */
        .post-table td:nth-child(6) {
        /* 작성일 */
        text-align: center;
      }

      .post-table th {
        background-color: #f8f8f8;
        font-weight: bold;
        color: #555;
        white-space: nowrap; /* 제목 줄바꿈 방지 */
      }

      .post-table tr:nth-child(even) {
        background-color: #fcfcfc;
      }

      .post-table tr:hover {
        background-color: #f0f0f0;
      }

      /* 기존 링크 스타일 유지, hover 시 밑줄 제거 */
      .post-table td a.post-title-link {
        /* 제목 링크에만 적용될 클래스 추가 */
        color: #2563eb;
        text-decoration: none; /* 기본 밑줄 제거 */
        font-weight: 500;
        transition: color 0.2s ease;
        cursor: pointer; /* 클릭 가능한 요소임을 명시 */
      }

      .post-table td a.post-title-link:hover {
        color: #1d4ed8;
        text-decoration: none; /* hover 시에도 밑줄 제거 */
      }

      /* 삭제된 게시글 제목 스타일 */
      .post-table .deleted-post-title {
        text-decoration: line-through; /* 취소선 */
        color: #999; /* 회색 텍스트 */
        cursor: default; /* 마우스 커서 변경 */
      }

      .post-table .view-count,
      .post-table .like-count {
        text-align: center;
      }

      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-top: 30px;
        gap: 10px;
        flex-wrap: wrap;
      }

      .pagination a,
      .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        text-decoration: none;
        color: #555;
        background-color: #fff;
        transition: all 0.2s ease;
        white-space: nowrap;
      }

      .pagination a:hover {
        background-color: #e0e0e0;
        border-color: #ccc;
        color: #333;
      }

      .pagination .current-page {
        background-color: #4f46e5;
        color: white;
        border-color: #4f46e5;
        font-weight: bold;
        cursor: default;
      }

      .pagination .disabled {
        background-color: #f0f0f0;
        color: #aaa;
        cursor: not-allowed;
      }
    </style>
    <link rel="icon" href="/icons/favicon.ico" type="image/x-icon" />
  </head>
  <body>
    <div class="container">
      <!-- 제목 -->
      <h1>게시글 목록</h1>

      <!-- 게시판 상단 -->
      <div class="header-actions">
        <!-- 검색창 -->
        <div class="search-form">
          <input
            type="text"
            id="keyword"
            placeholder="제목 검색"
            v-model="keyword"
            @keyup.enter="fetchPosts(1)"
          />
          <button type="button" @click="fetchPosts(1)">검색</button>
        </div>

        <!-- 정렬 박스 -->
        <select
          id="sortSelect"
          class="sort-select"
          v-model="sort"
          @change="fetchPosts(1)"
        >
          <option value="LATEST">최신순</option>
          <option value="OLDEST">오래된순</option>
          <option value="MOST_VIEWED">조회수순</option>
          <option value="MOST_LIKED">추천순</option>
        </select>

        <!-- '새 글 작성' 버튼 -->
        <a href="/posts/new" class="action-button">새 글 작성</a>
      </div>

      <!-- 게시판 -->
      <table class="post-table">
        <thead>
          <tr>
            <th>번호</th>
            <th>제목</th>
            <th>작성자</th>
            <th class="view-count">조회수</th>
            <th class="like-count">추천수</th>
            <th>작성일</th>
          </tr>
        </thead>
        <tbody>
          <!-- 게시글 요소 출력 -->
          <template v-if="posts && posts.length > 0">
            <tr v-for="post in posts" :key="post.postId">
              <td>{{ post.postId }}</td>
              <td>
                <!-- 삭제된 게시글의 제목 -->
                <template v-if="post.status === 'DELETED'">
                  <span class="deleted-post-title"> {{ post.title }} </span>
                </template>
                <!-- 일반 게시글 제목 (클릭 시, 게시글 단건 조회)-->
                <template v-else>
                  <a
                    href="#"
                    class="post-title-link"
                    @click.prevent="goToPostDetail(post.postId)"
                    >{{ post.title }}</a
                  >
                </template>
              </td>
              <td>{{ post.author }}</td>
              <td class="view-count">{{ post.viewCount }}</td>
              <td class="like-count">{{ post.likeCount }}</td>
              <td>{{ post.formattedCreatedAt }}</td>
            </tr>
          </template>
          <!-- 게시글이 존재하지 않는 경우 -->
          <template v-else>
            <tr>
              <td colspan="6" style="text-align: center; padding: 30px">
                게시글이 없습니다.
              </td>
            </tr>
          </template>
        </tbody>
      </table>

      <!-- 페이지네이션 -->
      <div class="pagination" v-if="pageInfo">
        <!-- '이전' 버튼 -->
        <span v-if="pageInfo.currentPage <= 1" class="disabled">이전</span>
        <a v-else href="#" @click.prevent="fetchPosts(pageInfo.currentPage - 1)"
          >이전</a
        >

        <template v-for="pageNumber in getPageNumbers()">
          <span v-if="pageNumber === pageInfo.currentPage" class="current-page"
            >{{ pageNumber }}</span
          >
          <a v-else href="#" @click.prevent="fetchPosts(pageNumber)"
            >{{ pageNumber }}</a
          >
        </template>

        <!-- 다음 버튼 -->
        <span
          v-if="pageInfo.currentPage >= pageInfo.totalPages"
          class="disabled"
          >다음</span
        >
        <a v-else href="#" @click.prevent="fetchPosts(pageInfo.currentPage + 1)"
          >다음</a
        >
      </div>
    </div>

    <script>
      const { createApp, ref, onMounted, computed } = Vue;

      createApp({
        setup() {
          const posts = ref([]);
          const pageInfo = ref(null);
          const currentPage = ref(1);
          const keyword = ref("");
          const sort = ref("LATEST");

          // ***** API 호출 (/posts) *****
          const fetchPosts = async (page = 1) => {
            currentPage.value = page;

            try {
              // 쿼리 파라미터 구성
              const params = new URLSearchParams({
                page: currentPage.value,
                sort: sort.value,
              });
              if (keyword.value) {
                params.append("keyword", keyword.value);
              }

              // Request
              const response = await fetch(`/api/posts?${params.toString()}`);

              // Response
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }

              const data = await response.json();

              posts.value = data.posts;
              pageInfo.value = data.pageInfo;
            } catch (error) {
              console.error("게시글을 가져오는 중 오류 발생:", error);

              posts.value = [];
              pageInfo.value = null;
            }
          };

          // ***** 페이지 번호 배열 생성 *****
          const getPageNumbers = () => {
            if (!pageInfo.value) return [];
            const numbers = [];

            // 페이지 번호 목록 생성
            for (
              let i = pageInfo.value.startPage;
              i <= pageInfo.value.lastPage;
              i++
            ) {
              // 전체 페이지 개수를 넘지 않도록 설정
              if (i <= pageInfo.value.totalPages) {
                numbers.push(i);
              }
            }
            return numbers;
          };

          // ***** API 호출 (/posts/${postId})
          const goToPostDetail = (postId) => {
            alert("hi");
            // window.location.href = `/posts/${postId}`;
          };

          // ***** 컴포넌트 마운트 시 게시글 목록 조회 *****
          onMounted(() => {
            // URL에서 초기 검색 조건 가져오기
            const urlParams = new URLSearchParams(window.location.search);
            const initialPage = parseInt(urlParams.get("page")) || 1;
            const initialKeyword = urlParams.get("keyword") || "";
            const initialSort = urlParams.get("sort") || "LATEST";

            currentPage.value = initialPage;
            keyword.value = initialKeyword;
            sort.value = initialSort;

            fetchPosts(currentPage.value);
          });

          return {
            posts,
            pageInfo,
            keyword,
            sort,
            fetchPosts,
            getPageNumbers,
            goToPostDetail,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
